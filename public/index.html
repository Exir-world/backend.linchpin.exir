<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FCM Notification Listener</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-messaging-compat.js"></script>
</head>

<body>
    <h1>📲 تست نوتیف فایربیس</h1>
    <p id="token">در حال دریافت توکن...</p>
    <p id="log"></p>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDcrm65-rQHOoLKNtPTwI-cOm851c1X3SU",
            authDomain: "linchpin-9c906.firebaseapp.com",
            projectId: "linchpin-9c906",
            storageBucket: "linchpin-9c906.firebasestorage.app",
            messagingSenderId: "200118688766",
            appId: "1:200118688766:web:970a436e624f6320853eaf",
            measurementId: "G-FV1MHWWEEJ"
        };

        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        async function initFCM() {
            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    document.getElementById('log').innerText = '❌ اجازه ارسال نوتیف داده نشد.';
                    return;
                }

                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');

                const token = await messaging.getToken({
                    vapidKey: 'BNYTnaaqgO6EjKRQy3dCwOtGNMdisGe0x_uUyikHLo7vRNb62muMOjcILcQUa1fuOo0wPhFLScibev4_eFZL_PM',
                    serviceWorkerRegistration: registration // ✅ فقط این کافیه
                });

                document.getElementById('token').innerText = `✅ توکن شما: ${token}`;
                console.log('FCM Token:', token);

                messaging.onMessage((payload) => {
                    console.log('🔔 پیام دریافتی:', payload);

                    const { title, body } = payload.notification;
                    new Notification(title, { body });

                    document.getElementById('log').innerText = `🔔 ${title}: ${body}`;
                });

            } catch (err) {
                console.error('❌ خطا در دریافت FCM:', err);
                document.getElementById('log').innerText = `❌ ${err.message}`;
            }
        }

        initFCM();
    </script>
</body>

</html>